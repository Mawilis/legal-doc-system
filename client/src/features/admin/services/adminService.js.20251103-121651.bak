// ~/client/src/features/admin/services/adminService.js
import http from '../../../services/http';
import { toast } from 'react-toastify';

function handleError(error) {
  const msg = error?.response?.data?.message || error?.message || 'Unknown error';
  toast.error(msg);
  throw new Error(msg);
}

// http has baseURL .../api, so use paths starting with /admin
export const getAllUsers = async () => {
  try {
    const { data } = await http.get('/admin/users');
    // Accept either an array or an envelope { users: [...] }
    return Array.isArray(data) ? data : (data?.users ?? []);
  } catch (e) { handleError(e); }
};

export const updateUser = async (userId, updates) => {
  try {
    const { data } = await http.put(`/admin/users/${userId}`, updates);
    return data;
  } catch (e) { handleError(e); }
};

export const deleteUser = async (userId) => {
  try {
    await http.delete(`/admin/users/${userId}`);
  } catch (e) { handleError(e); }
};

export const createUser = async (newUser) => {
  try {
    const { data } = await http.post('/admin/users', newUser);
    return data;
  } catch (e) { handleError(e); }
};

export const assignUserToTeam = async (userId, teamId) => {
  try {
    const { data } = await http.put(`/admin/users/${userId}/team`, { teamId });
    return data;
  } catch (e) { handleError(e); }
};

export const togglePermission = async (userId, module, value) => {
  try {
    const { data } = await http.patch(`/admin/users/${userId}/permissions`, { module, value });
    return data;
  } catch (e) { handleError(e); }
};

export const getAuditLogs = async () => {
  try {
    const { data } = await http.get('/admin/logs');
    return data;
  } catch (e) { handleError(e); }
};
