const fs = require('fs');

console.log('üõ†Ô∏è REPAIRING SHERIFF FORM...');

const cleanCode = `import React, { useState } from 'react';
import { Formik, Form, Field, ErrorMessage } from 'formik';
import * as Yup from 'yup';
import styled from 'styled-components';
import { useNavigate } from 'react-router-dom';
import { apiPost } from '../../../services/http'; 
import AddressAutocomplete from '../../../components/AddressAutocomplete';

// --- STYLES ---
const PageLayout = styled.div\`
  padding: 40px;
  background: #f0f4f8;
  font-family: 'Inter', sans-serif;
  min-height: 100vh;
  display: grid;
  grid-template-columns: 1fr 380px;
  gap: 30px;
\`;

const Card = styled.div\`
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.06);
  padding: 30px;
  margin-bottom: 24px;
  border: 1px solid #e1e4e8;
\`;

const SectionTitle = styled.h3\`
  font-size: 0.95rem;
  font-weight: 700;
  color: #1e293b;
  margin: 0 0 20px 0;
  padding-bottom: 10px;
  border-bottom: 1px solid #eee;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  display: flex;
  align-items: center;
  gap: 10px;
\`;

const Grid2 = styled.div\` display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; \`;
const Grid3 = styled.div\` display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 15px; \`;
const Label = styled.label\` display: block; font-size: 0.85rem; color: #475569; margin-bottom: 6px; font-weight: 600; \`;
const Input = styled(Field)\` width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.95rem; background:#fff; &:focus { outline: none; border-color: #2563eb; } \`;
const Select = styled(Field)\` width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.95rem; background: #fff; \`;
const ErrorText = styled(ErrorMessage)\` color: #ef4444; font-size: 0.75rem; margin-top: 4px; \`;
const ButtonPrimary = styled.button\` width: 100%; padding: 16px; background: #0f172a; color: #fff; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; margin-top:10px; font-size:1rem; \`;
const StatRow = styled.div\` display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #e2e8f0; font-size: 0.9rem; color: #334155; \`;

// --- 12-TYPE TAXONOMY ---
const SERVICE_TYPES = [
  { id: 'summons', label: '1. Service of Summons', base: 180, plan: '3 Attempts / 7 Days' },
  { id: 'urgent', label: '2. Urgent Service (Rule 6(12))', base: 450, plan: 'Immediate / 24 Hours' },
  { id: 'writ_movable', label: '3. Writ of Execution (Movables)', base: 950, plan: 'Attachment & Inventory' },
  { id: 'writ_immovable', label: '4. Writ of Execution (Immovables)', base: 1200, plan: 'Attachment & Notices' },
  { id: 'eviction', label: '5. Ejectment / Eviction', base: 1500, plan: 'SAPS Coordination Required' },
  { id: 'interdict', label: '6. Service of Interdict', base: 400, plan: 'Personal Service Mandatory' },
  { id: 'garnishee', label: '7. Garnishee Order', base: 350, plan: 'Service on Employer' },
  { id: 'bank', label: '8. Bank Attachment', base: 500, plan: 'Service on Bank HQ' },
  { id: 'subpoena', label: '9. Subpoena', base: 250, plan: 'Personal Service Preferred' },
  { id: 'substituted', label: '10. Substituted Service', base: 220, plan: 'Via Email/Publication' },
  { id: 'corporate', label: '11. Corporate Service', base: 280, plan: 'Registered Office (CIPC)' },
  { id: 'personal_strict', label: '12. Personal Service (Strict)', base: 300, plan: 'Hand Delivery Only' }
];

const URGENCY = ['normal', 'urgent', 'high'];

const calculatePricing = (typeId, distance, urgency, extras) => {
  const type = SERVICE_TYPES.find(t => t.id === typeId) || SERVICE_TYPES[0];
  let total = type.base;
  if (urgency === 'urgent') total *= 1.5;
  if (urgency === 'high') total *= 2.0;
  if (extras.afterHours) total *= 1.25;
  total += (distance * 6.50);
  if (extras.locksmith) total += 850;
  if (extras.security) total += 1200;
  if (extras.transport) total += 450;
  const vat = total * 0.15;
  return { base: type.base, travel: distance*6.5, vat, total: total + vat };
};

export default function SheriffInstructionForm() {
  const navigate = useNavigate();
  const [serverError, setServerError] = useState(null);

  const initialValues = {
    title: '', caseNumber: '', court: '',
    plaintiff: '', defendant: '',
    serviceType: 'summons',
    serviceAddress: '', street: '', city: '', province: '', postalCode: '',
    urgency: 'normal',
    distanceKm: 15,
    afterHours: false, locksmith: false, security: false, transport: false,
    documentCode: \`SHF-\${Date.now().toString().slice(-6)}\`,
    urgentReason: '', ruleReference: '',
    securityPlan: '', warehouseProvider: '', accessNotes: ''
  };

  const Schema = Yup.object().shape({
    title: Yup.string().required('Required'),
    caseNumber: Yup.string().required('Required'),
    court: Yup.string().required('Required'),
    street: Yup.string().required('Address Required'),
    distanceKm: Yup.number().min(0).required()
  });

  const handleSubmit = async (values, { setSubmitting }) => {
    try {
      const typeDef = SERVICE_TYPES.find(t => t.id === values.serviceType);
      const financials = calculatePricing(values.serviceType, values.distanceKm, values.urgency, {
        afterHours: values.afterHours, locksmith: values.locksmith, security: values.security, transport: values.transport
      });

      const payload = {
        ...values,
        attemptPlan: { 
            window: typeDef.plan, 
            minAttempts: values.urgency === 'normal' ? 3 : 1 
        },
        pricing: financials,
        serviceAddress: \`\${values.street}, \${values.city}, \${values.province}\`,
        classification: 'SHERIFF',
        status: 'Pending Dispatch'
      };

      await apiPost('/dispatch-instructions', payload);
      navigate('/documents');
    } catch (err) {
      setServerError(err.message || 'Server Error');
    } finally {
      setSubmitting(false);
    }
  };

  return (
    <Formik initialValues={initialValues} validationSchema={Schema} onSubmit={handleSubmit}>
      {({ values, setFieldValue, handleChange, isSubmitting }) => {
        const financials = calculatePricing(values.serviceType, values.distanceKm, values.urgency, {
           afterHours: values.afterHours, locksmith: values.locksmith, security: values.security, transport: values.transport
        });
        const currentType = SERVICE_TYPES.find(t => t.id === values.serviceType);

        return (
          <Form>
            <PageLayout>
              <div>
                <div style={{marginBottom:'30px'}}>
                    <div style={{background:'#0f172a', color:'#fff', padding:'5px 10px', borderRadius:'4px', display:'inline-block', fontSize:'0.75rem', fontWeight:'bold', marginBottom:'10px'}}>
                        SHERIFF OPERATIONS OS v2.0
                    </div>
                    <h1 style={{fontSize:'2rem', fontWeight:'800', color:'#0f172a', margin:0}}>New Dispatch Instruction</h1>
                </div>

                <Card>
                  <SectionTitle>‚öñÔ∏è Case Identity</SectionTitle>
                  <Grid2>
                    <div><Label>Title</Label><Input name="title" /><ErrorText name="title" component="div"/></div>
                    <div><Label>Code</Label><Input name="documentCode" disabled style={{background:'#f1f5f9'}} /></div>
                  </Grid2>
                  <Grid3>
                    <div><Label>Case Number</Label><Input name="caseNumber" /><ErrorText name="caseNumber" component="div"/></div>
                    <div><Label>Court</Label><Input name="court" /><ErrorText name="court" component="div"/></div>
                    <div><Label>Plaintiff</Label><Input name="plaintiff" /></div>
                  </Grid3>
                </Card>

                <Card>
                  <SectionTitle>üöö Logistics</SectionTitle>
                  <Grid2>
                    <div>
                        <Label>Service Type</Label>
                        <Select as="select" name="serviceType">
                            {SERVICE_TYPES.map(t=><option key={t.id} value={t.id}>{t.label}</option>)}
                        </Select>
                        <div style={{fontSize:'0.8rem', color:'#2563eb', marginTop:'5px', fontWeight:'600'}}>
                            Strategy: {currentType.plan}
                        </div>
                    </div>
                    <div>
                        <Label>Address</Label>
                        <AddressAutocomplete 
                            name="street" 
                            value={values.street} 
                            onChange={handleChange} 
                            onSelect={place => { 
                                setFieldValue('street', place.street); 
                                setFieldValue('city', place.city); 
                                setFieldValue('province', place.province); 
                                setFieldValue('postalCode', place.code); 
                            }} 
                        />
                        <ErrorText name="street" component="div"/>
                    </div>
                  </Grid2>
                  
                  <div style={{background:'#f8fafc', padding:'15px', borderRadius:'8px', marginTop:'20px'}}>
                      <Label style={{marginBottom:'10px'}}>Risk & Access</Label>
                      <Grid2>
                          <div><Input name="accessNotes" placeholder="Gate Codes / Security..." /></div>
                          <div style={{display:'flex', gap:'15px', alignItems:'center'}}>
                              <label><Field type="checkbox" name="afterHours" /> After Hours</label>
                              <label><Field type="checkbox" name="locksmith" /> Locksmith</label>
                              <label><Field type="checkbox" name="security" /> Security</label>
                          </div>
                      </Grid2>
                  </div>
                </Card>

                <ButtonPrimary type="submit" disabled={isSubmitting}>
                    {isSubmitting ? 'DISPATCHING...' : 'GENERATE INSTRUCTION'}
                </ButtonPrimary>
                {serverError && <div style={{color:'red', marginTop:'15px'}}>{serverError}</div>}
              </div>

              <div>
                <Card style={{position:'sticky', top:'20px'}}>
                    <SectionTitle>üí∞ Cost Estimate</SectionTitle>
                    <div style={{marginBottom:'25px'}}>
                        <Label>Distance: {values.distanceKm} km</Label>
                        <input type="range" min="0" max="100" value={values.distanceKm} onChange={handleChange} name="distanceKm" style={{width:'100%'}} />
                    </div>
                    <Label>Urgency</Label>
                    <Select as="select" name="urgency" style={{marginBottom:'20px'}}>
                        {URGENCY.map(u => <option key={u} value={u}>{u.toUpperCase()}</option>)}
                    </Select>
                    <div style={{background:'#f8fafc', padding:'15px', borderRadius:'8px'}}>
                        <StatRow><span>Base</span><span>R {financials.base.toFixed(2)}</span></StatRow>
                        <StatRow><span>Travel</span><span>R {financials.travel.toFixed(2)}</span></StatRow>
                        <StatRow><span>VAT</span><span>R {financials.vat.toFixed(2)}</span></StatRow>
                        <StatRow style={{borderTop:'2px solid #000', marginTop:'10px', paddingTop:'10px'}}>
                            <span>TOTAL</span><span style={{color:'#2563eb'}}>R {financials.total.toFixed(2)}</span>
                        </StatRow>
                    </div>
                </Card>
              </div>
            </PageLayout>
          </Form>
        );
      }}
    </Formik>
  );
}
`;

fs.writeFileSync('SheriffInstructionForm.jsx', cleanCode);
console.log('‚úÖ FIXED: SheriffInstructionForm.jsx has been repaired.');
