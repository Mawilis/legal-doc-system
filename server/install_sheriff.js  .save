const fs = require('fs');
const path = require('path');

console.log('üöÄ INITIALIZING WORLD-CLASS SHERIFF OS INSTALLER...');

// --- PATH CONFIGURATION ---
// We assume this script is run from inside /server or root. 
// We will look for client/src relative to where we are.
const currentDir = process.cwd();
let clientSrc = path.join(currentDir, '../client/src');

// Fallback if user is in root folder
if (!fs.existsSync(clientSrc)) {
    clientSrc = path.join(currentDir, 'client/src');
}

console.log(`üìÇ Target Client Source: ${clientSrc}`);

const componentsDir = path.join(clientSrc, 'components');
const featuresDir = path.join(clientSrc, 'features/sheriff/pages');

// Ensure directories exist
if (!fs.existsSync(componentsDir)) fs.mkdirSync(componentsDir, { recursive: true });
if (!fs.existsSync(featuresDir)) fs.mkdirSync(featuresDir, { recursive: true });

// =========================================================
// 1. THE ADDRESS AUTOCOMPLETE COMPONENT (Fixed)
// =========================================================
const addressCode = `import React, { useState, useEffect, useRef } from 'react';
import styled from 'styled-components';

const Wrapper = styled.div\`
  position: relative;
  width: 100%;
\`;

const StyledInput = styled.input\`
  width: 100%;
  padding: 12px;
  border: 1px solid \${props => props.$error ? '#dc2626' : '#cbd5e1'};
  border-radius: 6px;
  font-size: 0.95rem;
  background: #fff;
  transition: all 0.2s;
  &:focus { 
    outline: none; 
    border-color: #2563eb; 
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }
\`;

const Suggestions = styled.ul\`
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  margin-top: 4px;
  padding: 0;
  list-style: none;
  z-index: 100;
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
  max-height: 250px;
  overflow-y: auto;
\`;

const Item = styled.li\`
  padding: 12px 15px;
  cursor: pointer;
  font-size: 0.9rem;
  color: #374151;
  border-bottom: 1px solid #f3f4f6;
  display: flex;
  align-items: center;
  gap: 10px;
  
  &:hover { background: #eff6ff; color: #2563eb; }
  &:last-child { border-bottom: none; }
  
  strong { font-weight: 600; color: #111; }
\`;

const SA_PLACES = [
  { street: '100 Rivonia Road', city: 'Sandton', province: 'Gauteng', code: '2196' },
  { street: '15 Alice Lane', city: 'Sandton', province: 'Gauteng', code: '2196' },
  { street: '50 Church Square', city: 'Pretoria', province: 'Gauteng', code: '0002' },
  { street: '7 Hout Street', city: 'Cape Town', province: 'Western Cape', code: '8000' },
  { street: '200 Florida Road', city: 'Durban', province: 'KwaZulu-Natal', code: '4001' },
  { street: '5 Lagoon Drive', city: 'Umhlanga', province: 'KwaZulu-Natal', code: '4319' },
  { street: '10 High Street', city: 'Melrose Arch', province: 'Gauteng', code: '2076' }
];

export default function AddressAutocomplete({ value, onChange, onSelect, error, name }) {
  const [query, setQuery] = useState(value || '');
  const [results, setResults] = useState([]);
  const [show, setShow] = useState(false);
  const wrapperRef = useRef(null);

  useEffect(() => { setQuery(value || ''); }, [value]);

  useEffect(() => {
    function handleClickOutside(event) {
      if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
        setShow(false);
      }
    }
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  const handleInput = (e) => {
    const val = e.target.value;
    setQuery(val);
    onChange(e); 

    if (val.length > 1) {
      const filtered = SA_PLACES.filter(p => 
        p.street.toLowerCase().includes(val.toLowerCase()) || 
        p.city.toLowerCase().includes(val.toLowerCase())
      );
      setResults(filtered);
      setShow(true);
    } else {
      setShow(false);
    }
  };

  const handleSelection = (place) => {
    setQuery(place.street);
    setShow(false);
    onSelect(place);
  };

  return (
    <Wrapper ref={wrapperRef}>
      <StyledInput 
        name={name}
        value={query} 
        onChange={handleInput} 
        placeholder="Start typing address..." 
        autoComplete="off" 
        $error={!!error}
      />
      {show && results.length > 0 && (
        <Suggestions>
          {results.map((r, i) => (
            <Item key={i} onClick={() => handleSelection(r)}>
              <span>üìç</span>
              <div>
                <strong>{r.street}</strong>
                <div style={{fontSize:'0.8rem', color:'#666'}}>{r.city}, {r.province}</div>
              </div>
            </Item>
          ))}
        </Suggestions>
      )}
    </Wrapper>
  );
}
`;

// =========================================================
// 2. THE ADVANCED SHERIFF FORM (12 Types + Algo)
// =========================================================
const sheriffCode = `import React, { useMemo, useState } from 'react';
import { Formik, Form, Field, ErrorMessage } from 'formik';
import * as Yup from 'yup';
import styled from 'styled-components';
import { useNavigate } from 'react-router-dom';
import { apiPost } from '../../../services/http'; 
import AddressAutocomplete from '../../../components/AddressAutocomplete';

// --- STYLES ---
const Page = styled.div\` padding: 40px; background: #f0f4f8; font-family: 'Inter', sans-serif; min-height: 100vh; display: grid; grid-template-columns: 1fr 380px; gap: 30px; \`;
const Card = styled.div\` background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); padding: 30px; margin-bottom: 24px; border: 1px solid #e1e4e8; \`;
const SectionTitle = styled.h3\` font-size: 0.95rem; font-weight: 700; color: #1e293b; margin: 0 0 20px 0; padding-bottom: 10px; border-bottom: 1px solid #eee; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 10px; \`;
const Grid2 = styled.div\` display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; \`;
const Grid3 = styled.div\` display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 15px; \`;
const Label = styled.label\` display: block; font-size: 0.85rem; color: #475569; margin-bottom: 6px; font-weight: 600; \`;
const Input = styled(Field)\` width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.95rem; background:#fff; &:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37,99,235,0.1); } \`;
const Select = styled(Field)\` width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.95rem; background: #fff; \`;
const ErrorText = styled(ErrorMessage)\` color: #ef4444; font-size: 0.75rem; margin-top: 4px; \`;
const ButtonPrimary = styled.button\` width: 100%; padding: 16px; background: #0f172a; color: #fff; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: background 0.2s; margin-top:10px; font-size:1rem; &:hover { background: #1e293b; } &:disabled { background: #94a3b8; } \`;
const StatRow = styled.div\` display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #e2e8f0; font-size: 0.9rem; color: #334155; &:last-child { border-bottom: none; font-weight: 700; color: #0f172a; font-size: 1.1rem; border-top: 2px solid #0f172a; margin-top:10px; padding-top:15px; } \`;

// --- 12-TYPE TAXONOMY ---
const SERVICE_TYPES = [
  { id: 'summons', label: '1. Service of Summons', base: 180, plan: '3 Attempts / 7 Days' },
  { id: 'urgent', label: '2. Urgent Service (Rule 6(12))', base: 450, plan: 'Immediate / 24 Hours' },
  { id: 'writ_movable', label: '3. Writ of Execution (Movables)', base: 950, plan: 'Attachment & Inventory' },
  { id: 'writ_immovable', label: '4. Writ of Execution (Immovables)', base: 1200, plan: 'Attachment & Notices' },
  { id: 'eviction', label: '5. Ejectment / Eviction', base: 1500, plan: 'SAPS Coordination Required' },
  { id: 'interdict', label: '6. Service of Interdict', base: 400, plan: 'Personal Service Mandatory' },
  { id: 'garnishee', label: '7. Garnishee Order', base: 350, plan: 'Service on Employer' },
  { id: 'bank', label: '8. Bank Attachment', base: 500, plan: 'Service on Bank HQ' },
  { id: 'subpoena', label: '9. Subpoena', base: 250, plan: 'Personal Service Preferred' },
  { id: 'substituted', label: '10. Substituted Service', base: 220, plan: 'Via Email/Publication' },
  { id: 'corporate', label: '11. Corporate Service', base: 280, plan: 'Registered Office (CIPC)' },
  { id: 'personal_strict', label: '12. Personal Service (Strict)', base: 300, plan: 'Hand Delivery Only' }
];

const URGENCY = ['normal', 'urgent', 'high'];

// --- ALGORITHMIC PRICING ENGINE ---
const calculatePricing = (typeId, distance, urgency, extras) => {
  const type = SERVICE_TYPES.find(t => t.id === typeId) || SERVICE_TYPES[0];
  let total = type.base;
  
  if (urgency === 'urgent') total *= 1.5;
  if (urgency === 'high') total *= 2.0;
  if (extras.afterHours) total *= 1.25;

  const travel = distance * 6.50; 
  total += travel;

  if (extras.locksmith) total += 850;
  if (extras.security) total += 1200;
  if (extras.transport) total += 450;

  const vat = total * 0.15;
  return { base: type.base, travel, vat, total: total + vat };
};

export default function SheriffInstructionForm() {
  const navigate = useNavigate();
  const [serverError, setServerError] = useState(null);

  const initialValues = {
    title: '', caseNumber: '', court: '',
    plaintiff: '', defendant: '',
    serviceType: 'summons',
    serviceAddress: '', street: '', city: '', province: '', postalCode: '',
    urgency: 'normal',
    distanceKm: 15,
    afterHours: false, locksmith: false, security: false, transport: false,
    documentCode: \`SHF-\${Date.now().toString().slice(-6)}\`,
    urgentReason: '', ruleReference: '',
    securityPlan: '', warehouseProvider: '', accessNotes: ''
  };

  const Schema = Yup.object().shape({
    title: Yup.string().required('Title Required'),
    caseNumber: Yup.string().required('Case Number Required'),
    court: Yup.string().required('Court Required'),
    street: Yup.string().required('Address Required'),
    distanceKm: Yup.number().min(0).required()
  });

  const handleSubmit = async (values, { setSubmitting }) => {
    try {
      const typeDef = SERVICE_TYPES.find(t => t.id === values.serviceType);
      const financials = calculatePricing(values.serviceType, values.distanceKm, values.urgency, {
        afterHours: values.afterHours, locksmith: values.locksmith, security: values.security, transport: values.transport
      });

      const payload = {
        ...values,
        attemptPlan: { 
            window: typeDef.plan, 
            minAttempts: values.urgency === 'normal' ? 3 : 1 
        },
        pricing: financials,
        serviceAddress: \`\${values.street}, \${values.city}, \${values.province}\`,
        classification: 'SHERIFF',
        status: 'Pending Dispatch'
      };

      await apiPost('/dispatch-instructions', payload);
      navigate('/documents');
    } catch (err) {
      setServerError(err.message || 'Server Error');
    } finally {
      setSubmitting(false);
    }
  };

  return (
    <Page>
      <div>
        <div style={{marginBottom:'30px'}}>
            <div style={{background:'#0f172a', color:'#fff', padding:'5px 10px', borderRadius:'4px', display:'inline-block', fontSize:'0.75rem', fontWeight:'bold', marginBottom:'10px'}}>
                SHERIFF OPERATIONS OS v2.0
            </div>
            <h1 style={{fontSize:'2rem', fontWeight:'800', color:'#0f172a', margin:0}}>New Dispatch Instruction</h1>
            <p style={{color:'#64748b', fontSize:'1.1rem'}}>Orchestrate service, execution, and attachments.</p>
        </div>

        <Formik initialValues={initialValues} validationSchema={Schema} onSubmit={handleSubmit}>
          {({ values, setFieldValue, handleChange, isSubmitting }) => {
            const financials = calculatePricing(values.serviceType, values.distanceKm, values.urgency, {
               afterHours: values.afterHours, locksmith: values.locksmith, security: values.security, transport: values.transport
            });
            const currentType = SERVICE_TYPES.find(t => t.id === values.serviceType);

            return (
              <Form>
                <Card>
                  <SectionTitle>‚öñÔ∏è Case Identity</SectionTitle>
                  <Grid2>
                    <div><Label>Instruction Title</Label><Input name="title" placeholder="e.g. Service of Summons: ABC vs XYZ" /><ErrorText name="title" component="div"/></div>
                    <div><Label>System Code</Label><Input name="documentCode" disabled style={{background:'#f1f5f9', color:'#64748b'}} /></div>
                  </Grid2>
                  <Grid3>
                    <div><Label>Case Number</Label><Input name="caseNumber" /><ErrorText name="caseNumber" component="div"/></div>
                    <div><Label>Jurisdiction (Court)</Label><Input name="court" /><ErrorText name="court" component="div"/></div>
                    <div><Label>Plaintiff Ref</Label><Input name="plaintiff" placeholder="Your Client" /></div>
                  </Grid3>
                </Card>

                <Card>
                  <SectionTitle>üöö Logistics & Taxonomy</SectionTitle>
                  <Grid2>
                    <div>
                        <Label>Service Type (12 Classifications)</Label>
                        <Select as="select" name="serviceType">
                            {SERVICE_TYPES.map(t=><option key={t.id} value={t.id}>{t.label}</option>)}
                        </Select>
                        <div style={{fontSize:'0.8rem', color:'#2563eb', marginTop:'5px', fontWeight:'600'}}>
                            Strategy: {currentType.plan}
                        </div>
                    </div>
                    <div>
                        <Label>Target Address</Label>
                        <AddressAutocomplete 
                            name="street" 
                            value={values.street} 
                            onChange={handleChange} 
                            onSelect={place => { 
                                setFieldValue('street', place.street); 
                                setFieldValue('city', place.city); 
                                setFieldValue('province', place.province); 
                                setFieldValue('postalCode', place.code); 
                            }} 
                        />
                        <ErrorText name="street" component="div"/>
                    </div>
                  </Grid2>
                  
                  <div style={{background:'#f8fafc', padding:'15px', borderRadius:'8px', marginTop:'20px', border:'1px solid #e2e8f0'}}>
                      <Label style={{marginBottom:'10px'}}>Risk & Access Control</Label>
                      <Grid2>
                          <div><Input name="accessNotes" placeholder="Gate Codes, Dog Warnings, Security..." /></div>
                          <div style={{display:'flex', gap:'15px', alignItems:'center'}}>
                              <label><Field type="checkbox" name="afterHours" /> After Hours</label>
                              <label><Field type="checkbox" name="locksmith" /> Locksmith</label>
                              <label><Field type="checkbox" name="security" /> SAPS/Security</label>
                          </div>
                      </Grid2>
                  </div>

                  {values.serviceType === 'urgent' && (
                      <div style={{marginTop:'20px', borderLeft:'3px solid #ef4444', paddingLeft:'15px'}}>
                          <Label style={{color:'#ef4444'}}>Urgency Justification (Rule 6(12))</Label>
                          <Grid2>
                              <Input name="urgentReason" placeholder="Why can this not wait?" />
                              <Input name="ruleReference" placeholder="Legal Rule Ref" />
                          </Grid2>
                      </div>
                  )}
                  {(values.serviceType.includes('writ') || values.serviceType === 'eviction') && (
                      <div style={{marginTop:'20px', borderLeft:'3px solid #f59e0b', paddingLeft:'15px'}}>
                          <Label style={{color:'#d97706'}}>Execution Logistics</Label>
                          <Grid2>
                              <Input name="securityPlan" placeholder="Security Provider Name" />
                              <Input name="warehouseProvider" placeholder="Warehouse / Storage Facility" />
                          </Grid2>
                      </div>
                  )}
                </Card>

                <ButtonPrimary type="submit" disabled={isSubmitting}>
                    {isSubmitting ? 'DISPATCHING...' : 'GENERATE INSTRUCTION PACKET'}
                </ButtonPrimary>
                {serverError && <div style={{color:'red', marginTop:'15px', fontWeight:'bold'}}>{serverError}</div>}
              </Form>
            );
          }}
        </Formik>
      </div>

      <div>
        <Card style={{position:'sticky', top:'20px'}}>
            <SectionTitle>üí∞ Algorithmic Pricing</SectionTitle>
            
            <div style={{marginBottom:'25px'}}>
                <Label>Travel Distance</Label>
                <div style={{display:'flex', alignItems:'center', gap:'10px'}}>
                    <Input type="number" name="distanceKm" style={{width:'80px'}} />
                    <span style={{color:'#64748b'}}>km from Sheriff Office</span>
                </div>
                <input 
                    type="range" min="0" max="100" 
                    value={initialValues.distanceKm} 
                    style={{width:'100%', marginTop:'10px', accentColor:'#0f172a'}} 
                />
            </div>

            <Label>Urgency Multiplier</Label>
            <Select as="select" name="urgency" style={{marginBottom:'20px'}}>
                {URGENCY.map(u => <option key={u} value={u}>{u.toUpperCase()}</option>)}
            </Select>

            <div style={{background:'#f8fafc', padding:'15px', borderRadius:'8px', border:'1px solid #e2e8f0'}}>
                <StatRow><span>Base Tariff</span><span>R {financials.base.toFixed(2)}</span></StatRow>
                <StatRow><span>Travel Fee</span><span>R {financials.travel.toFixed(2)}</span></StatRow>
                <StatRow><span>VAT (15%)</span><span>R {financials.vat.toFixed(2)}</span></StatRow>
                <StatRow><span>TOTAL EST.</span><span style={{color:'#2563eb'}}>R {financials.total.toFixed(2)}</span></StatRow>
            </div>
        </Card>
      </div>
    </Page>
  );
}
`;

// =========================================================
// 3. EXECUTE WRITE
// =========================================================

try {
    fs.writeFileSync(path.join(componentsDir, 'AddressAutocomplete.jsx'), addressCode);
    console.log('‚úÖ INSTALLED: AddressAutocomplete.jsx');
    
    fs.writeFileSync(path.join(featuresDir, 'SheriffInstructionForm.jsx'), sheriffCode);
    console.log('‚úÖ INSTALLED: SheriffInstructionForm.jsx (World-Class Edition)');
    
    console.log('‚ú® SUCCESS! Components have been written directly to disk.');
    console.log('üëâ ACTION: Restart your client/server to see the changes.');

} catch (err) {
    console.error('‚ùå Installation Failed:', err);
}


